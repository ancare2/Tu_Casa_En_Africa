<script>
  // Variables globales
  let recognition, isRecording = false;
  let textoCompleto = "";
  let campoSeleccionado = null;
  let filaActual = null;
  let modoEdicion = false;
  let modoBorrado = false;

  const campos = ['nombre', 'edad', 'pueblo', 'motivo', 'diagnostico', 'tratamiento', 'seguimiento'];

  // Referencias DOM
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const guardarRegistroBtn = document.getElementById('guardarRegistro');
  const descargarExcelBtn = document.getElementById('descargarExcel');
  const campoSeleccionadoSpan = document.getElementById('campoSeleccionado');
  const transcripcionDiv = document.getElementById('transcripcion');
  const checkTranscripcionBtn = document.getElementById('checkTranscripcion');
  const wrongTranscripcionBtn = document.getElementById('wrongTranscripcion');
  const tablaBody = document.getElementById('tablaBody');
  const eliminarTodosBtn = document.getElementById('eliminarTodosBtn');
  const toggleEdicionBtn = document.getElementById('toggleEdicionBtn');
  const activarBorradoBtn = document.getElementById('activarBorradoBtn');
  const buscarRegistroBtn = document.getElementById('buscarRegistroBtn');
  const inputBusqueda = document.getElementById('inputBusqueda');
  const cerrarBusquedaBtn = document.getElementById('cerrarBusquedaBtn');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const editModal = document.getElementById('editModal');
  const editFieldBtn = document.getElementById('editField');
  const cancelModalBtn = document.getElementById('cancelModal');
  const editContainer = document.getElementById('editContainer');
  const editTextarea = document.getElementById('editTextarea');
  const guardarEdicionBtn = document.getElementById('guardarEdicion');
  const editFieldLabel = document.getElementById('editFieldLabel');

  // Función para convertir texto a número (simplificada)
  function textoANumero(texto) {
    const unidades = {
      'cero':0,'uno':1,'una':1,'dos':2,'tres':3,'cuatro':4,'cinco':5,'seis':6,'siete':7,'ocho':8,'nueve':9
    };
    const especiales = {
      'diez':10,'once':11,'doce':12,'trece':13,'catorce':14,'quince':15,
      'dieciseis':16,'diecisiete':17,'dieciocho':18,'diecinueve':19,
      'veinte':20,'veintiuno':21,'veintidos':22,'veintitres':23,'veinticuatro':24,
      'veinticinco':25,'veintiseis':26,'veintisiete':27,'veintiocho':28,'veintinueve':29
    };
    const decenas = {
      'treinta':30,'cuarenta':40,'cincuenta':50,'sesenta':60,'setenta':70,'ochenta':80,'noventa':90
    };

    texto = texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    texto = texto.replace(/\s+/g,''); // eliminar espacios

    if (especiales[texto] !== undefined) return especiales[texto];
    if (unidades[texto] !== undefined) return unidades[texto];
    if (decenas[texto] !== undefined) return decenas[texto];

    // Manejar decenas y unidades unidas por 'y' o 'i'
    let partes = texto.split('y');
    if (partes.length === 2) {
      let dec = decenas[partes[0]];
      let uni = unidades[partes[1]];
      if (dec !== undefined && uni !== undefined) return dec + uni;
    }
    partes = texto.split('i');
    if (partes.length === 2) {
      let dec = decenas[partes[0]];
      let uni = unidades[partes[1]];
      if (dec !== undefined && uni !== undefined) return dec + uni;
    }

    return texto;
  }

  function convertirSiEsNumero(texto) {
    let n = textoANumero(texto);
    if (typeof n === 'number' && !isNaN(n)) {
      return n.toString();
    }
    return texto;
  }

  function actualizarEstadoBotones() {
    if (startBtn) startBtn.disabled = (campoSeleccionado === null);
    if (stopBtn) stopBtn.disabled = true;
  }

  document.querySelectorAll('.field-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.field-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      campoSeleccionado = btn.dataset.field;
      if (campoSeleccionadoSpan) campoSeleccionadoSpan.textContent = btn.textContent;
      textoCompleto = "";
      if (transcripcionDiv) transcripcionDiv.textContent = "";
      actualizarEstadoBotones();
    });
  });

  try {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isRecording = true;
      if (startBtn) startBtn.disabled = true;
      if (stopBtn) stopBtn.disabled = false;
    };

    recognition.onresult = (event) => {
      let interimTranscript = "";
      for (let i = event.resultIndex; i < event.results.length; i++) {
        let transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          textoCompleto += transcript.trim() + " ";
        } else {
          interimTranscript += transcript;
        }
      }
      if (transcripcionDiv) transcripcionDiv.textContent = textoCompleto + interimTranscript;
    };

    recognition.onerror = (event) => {
      alert("Error en reconocimiento de voz: " + event.error);
      isRecording = false;
      if (startBtn) startBtn.disabled = false;
      if (stopBtn) stopBtn.disabled = true;
    };

    recognition.onend = () => {
      isRecording = false;
      if (startBtn) startBtn.disabled = false;
      if (stopBtn) stopBtn.disabled = true;
    };

  } catch (e) {
    alert("No se soporta reconocimiento de voz en este navegador.");
    if (startBtn) startBtn.disabled = true;
    if (stopBtn) stopBtn.disabled = true;
  }

  if (startBtn) startBtn.addEventListener('click', () => {
    if (recognition && !isRecording) {
      textoCompleto = "";
      if (transcripcionDiv) transcripcionDiv.textContent = "";
      recognition.start();
    }
  });

  if (stopBtn) stopBtn.addEventListener('click', () => {
    if (recognition && isRecording) {
      recognition.stop();
    }
  });

  if (checkTranscripcionBtn) checkTranscripcionBtn.addEventListener('click', () => {
    if (!campoSeleccionado) {
      alert('Selecciona un campo primero');
      return;
    }
    if (!textoCompleto.trim()) {
      alert('No hay texto para guardar');
      return;
    }
    let valorFinal = textoCompleto.trim();
    if (campoSeleccionado === 'edad') {
      valorFinal = convertirSiEsNumero(valorFinal);
    }
    agregarOActualizarRegistro(campoSeleccionado, valorFinal);
    textoCompleto = "";
    if (transcripcionDiv) transcripcionDiv.textContent = "";
  });

  if (wrongTranscripcionBtn) wrongTranscripcionBtn.addEventListener('click', () => {
    if (!textoCompleto.trim()) {
      alert('No hay texto para editar');
      return;
    }
    abrirModalEdicion(campoSeleccionado, textoCompleto.trim());
  });

  function agregarOActualizarRegistro(campo, valor) {
    if (!filaActual && campo === 'nombre') {
      filaActual = document.createElement('tr');
      filaActual.classList.add('borrable');
      campos.forEach(c => {
        const td = document.createElement('td');
        td.textContent = "";
        td.dataset.field = c;
        td.classList.add('editable');
        filaActual.appendChild(td);
      });
      tablaBody.appendChild(filaActual);
    }

    if (!filaActual) {
      alert('Por favor, introduce primero el Nombre y Apellidos antes que otros campos.');
      return;
    }

    const celda = Array.from(filaActual.children).find(td => td.dataset.field === campo);
    if (celda) {
      celda.textContent = valor;
    }
  }


  if (guardarRegistroBtn) guardarRegistroBtn.addEventListener('click', () => {
    if (!filaActual) {
      alert('No hay datos para guardar');
      return;
    }
    const nombre = filaActual.querySelector('[data-field="nombre"]').textContent.trim();
    if (!nombre) {
      alert('El campo "Nombre y Apellidos" es obligatorio');
      return;
    }
    filaActual = null;
    campoSeleccionado = null;
    if (campoSeleccionadoSpan) campoSeleccionadoSpan.textContent = 'Ninguno';
    actualizarEstadoBotones();
    document.querySelectorAll('.field-btn').forEach(b => b.classList.remove('active'));
    alert('Registro guardado');
  });

  if (descargarExcelBtn) descargarExcelBtn.addEventListener('click', () => {
    const wb = XLSX.utils.book_new();
    let data = [];
    const header = campos.map(c => {
      switch(c) {
        case 'nombre': return 'Nombre y Apellidos';
        case 'edad': return 'Edad';
        case 'pueblo': return 'Pueblo';
        case 'motivo': return 'Motivo';
        case 'diagnostico': return 'Diagnóstico';
        case 'tratamiento': return 'Tratamiento';
        case 'seguimiento': return '¿Seguimiento?';
        default: return c;
      }
    });
    data.push(header);

    Array.from(tablaBody.children).forEach(tr => {
      const fila = [];
      campos.forEach(campo => {
        const celda = tr.querySelector(`[data-field="${campo}"]`);
        fila.push(celda ? celda.textContent : '');
      });
      data.push(fila);
    });

    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Registros");
    XLSX.writeFile(wb, "Registros.xlsx");
  });

  eliminarTodosBtn.addEventListener('click', () => {
    if (confirm('¿Estás seguro de eliminar todos los registros?')) {
      tablaBody.innerHTML = "";
      filaActual = null;
      campoSeleccionado = null;
      if (campoSeleccionadoSpan) campoSeleccionadoSpan.textContent = 'Ninguno';
      actualizarEstadoBotones();
    }
  });

  toggleEdicionBtn.addEventListener('click', () => {
    modoEdicion = !modoEdicion;
    toggleEdicionBtn.textContent = modoEdicion ? '❌ Cancelar edición' : '✏️ Editar registros';
    if (modoEdicion) {
      activarBorradoBtn.style.display = 'none';
      buscarRegistroBtn.style.display = 'inline-block';
      inputBusqueda.style.display = 'none';
      cerrarBusquedaBtn.style.display = 'none';
      tablaBody.querySelectorAll('tr').forEach(tr => {
        tr.querySelectorAll('td.editable').forEach(td => {
          td.setAttribute('contenteditable', 'true');
          td.style.backgroundColor = '#ffffdd';
        });
      });
    } else {
      tablaBody.querySelectorAll('tr').forEach(tr => {
        tr.querySelectorAll('td.editable').forEach(td => {
          td.removeAttribute('contenteditable');
          td.style.backgroundColor = '';
        });
      });
      activarBorradoBtn.style.display = 'inline-block'
    }
  });

  activarBorradoBtn.addEventListener('click', () => {
    modoBorrado = !modoBorrado;
    activarBorradoBtn.textContent = modoBorrado ? '✔️ Confirmar borrado' : '❌ Borrar registro';
    if (modoBorrado) {
      toggleEdicionBtn.style.display = 'none';
      buscarRegistroBtn.style.display = 'none';
      inputBusqueda.style.display = 'none';
      cerrarBusquedaBtn.style.display = 'none';
      tablaBody.querySelectorAll('tr').forEach(tr => {
        tr.style.cursor = 'pointer';
        tr.classList.add('borrable');
      });
    } else {
      toggleEdicionBtn.style.display = 'inline-block';
      buscarRegistroBtn.style.display = 'inline-block';
      tablaBody.querySelectorAll('tr').forEach(tr => {
        tr.style.cursor = '';
        tr.classList.remove('borrable');
      });
    }
  });

  tablaBody.addEventListener('click', (e) => {
    let tr = e.target.closest('tr');
    if (!tr) return;

    if (modoBorrado) {
      if (confirm('¿Eliminar este registro?')) {
        tr.remove();
      }
    }
  });

  buscarRegistroBtn.addEventListener('click', () => {
    buscarRegistroBtn.style.display = 'none';
    inputBusqueda.style.display = 'inline-block';
    cerrarBusquedaBtn.style.display = 'inline-block';
    inputBusqueda.focus();
  });

  cerrarBusquedaBtn.addEventListener('click', () => {
    inputBusqueda.value = "";
    cerrarBusquedaBtn.style.display = 'none';
    inputBusqueda.style.display = 'none';
    buscarRegistroBtn.style.display = 'inline-block';
    mostrarTodasFilas();
  });

  inputBusqueda.addEventListener('input', () => {
    let valor = inputBusqueda.value.trim().toLowerCase();
    if (!valor) {
      mostrarTodasFilas();
      return;
    }
    filtrarRegistros(valor);
  });

  function mostrarTodasFilas() {
    tablaBody.querySelectorAll('tr').forEach(tr => {
      tr.style.display = '';
    });
  }

  function filtrarRegistros(texto) {
    tablaBody.querySelectorAll('tr').forEach(tr => {
      const contenido = tr.textContent.toLowerCase();
      tr.style.display = contenido.includes(texto) ? '' : 'none';
    });
  }

  // Modal para editar texto mal transcrito
  function abrirModalEdicion(campo, texto) {
    if (!campo) {
      alert('Selecciona un campo primero');
      return;
    }
    editFieldLabel.textContent = 'Editar ' + campo.charAt(0).toUpperCase() + campo.slice(1);
    editTextarea.value = texto;
    modalBackdrop.style.display = 'flex';
    editTextarea.focus();

    guardarEdicionBtn.onclick = () => {
      agregarOActualizarRegistro(campo, editTextarea.value.trim());
      modalBackdrop.style.display = 'none';
      textoCompleto = "";
      if (transcripcionDiv) transcripcionDiv.textContent = "";
    };
    cancelModalBtn.onclick = () => {
      modalBackdrop.style.display = 'none';
    };
  }

  // Inicial
  actualizarEstadoBotones();
</script>

