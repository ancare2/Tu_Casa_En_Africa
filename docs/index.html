<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Tu Casa en África - Registro de Consulta</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 20px;
      background-color: #f3f6f9;
      color: #2c3e50;
    }

    h1, h2 {
      color: #1a3c40;
    }

    .field-btn {
      margin: 5px;
      padding: 10px 16px;
      cursor: pointer;
      border: none;
      background-color: #d0e8e4;
      border-radius: 6px;
      transition: background 0.3s;
      color: #1a3c40;
      font-weight: bold;
    }

    .field-btn:hover {
      background-color: #b8dcd6;
    }

    .field-btn.active {
      background-color: #2c9c7b;
      color: white;
    }

    textarea.field-output {
      margin-bottom: 10px;
      width: 280px;
      height: 40px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      background-color: #fff;
    }

    #transcripcion {
      min-height: 30px;
      border: 1px solid #ccc;
      padding: 6px;
      width: 400px;
      background-color: #fff;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    /* Ajuste para subir botones ✔️ y ❌ */
    .trans-control {
      margin-left: 10px;
      display: flex;
      gap: 10px;
      margin-top: -6px; /* Subir botones un poco */
    }

    .trans-control button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .trans-control button:hover {
      opacity: 0.7;
    }

    .edit-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      border-radius: 8px;
      display: none;
      z-index: 1000;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 999;
    }

    table {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
      max-width: 800px;
      background-color: white;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #eef2f3;
      font-weight: bold;
      color: #2c3e50;
    }

    #startBtn, #stopBtn {
      margin-right: 10px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
    }

    #startBtn {
      background-color: #4caf50;
      color: white;
    }

    #stopBtn {
      background-color: #e74c3c;
      color: white;
    }

    .transcripcion-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <h1>Tu Casa en África – Registro de Consulta</h1>

  <div>
    <button class="field-btn" data-field="nombre">Nombre y Apellidos</button>
    <button class="field-btn" data-field="edad">Edad</button>
    <button class="field-btn" data-field="pueblo">Pueblo</button>
    <button class="field-btn" data-field="motivo">Motivo</button>
    <button class="field-btn" data-field="diagnostico">Diagnóstico</button>
    <button class="field-btn" data-field="tratamiento">Tratamiento</button>
    <button class="field-btn" data-field="seguimiento">¿Seguimiento?</button>
  </div>

  <div style="margin-top:20px;">
    <button id="startBtn" disabled>Empezar</button>
    <button id="stopBtn" disabled>Detener</button>
  </div>

  <p><strong>Campo seleccionado:</strong> <span id="campoSeleccionado">Ninguno</span></p>
  <p><strong>Transcripción en vivo:</strong></p>
  <div class="transcripcion-container">
    <div id="transcripcion"></div>
    <div class="trans-control">
      <button id="checkTranscripcion" title="Confirmar transcripción">✔️</button>
      <button id="wrongTranscripcion" title="Editar transcripción">❌</button>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop"></div>
  <div class="edit-modal" id="editModal">
    <p>¿Deseas volver a grabar este campo o editarlo manualmente?</p>
    <button id="editField">Editar campo</button>
    <button onclick="cerrarModal()">Cancelar</button>
    <div id="editContainer" style="margin-top:10px; display:none;">
      <label id="editFieldLabel"></label>
      <textarea id="editTextarea" style="width:100%; height:60px;"></textarea>
      <button onclick="guardarEdicion()">Guardar</button>
    </div>
  </div>

  <h2>Resumen</h2>
  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Edad</th>
        <th>Pueblo</th>
        <th>Motivo</th>
        <th>Diagnóstico</th>
        <th>Tratamiento</th>
        <th>¿Seguimiento?</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="tabla-nombre"></td>
        <td id="tabla-edad"></td>
        <td id="tabla-pueblo"></td>
        <td id="tabla-motivo"></td>
        <td id="tabla-diagnostico"></td>
        <td id="tabla-tratamiento"></td>
        <td id="tabla-seguimiento"></td>
      </tr>
    </tbody>
  </table>

  <script>
    let recognition, isRecording = false, textoCompleto = "";
    let campoSeleccionado = null;
    const camposGuardados = {};

    const transcripcionP = document.getElementById("transcripcion");
    const campoSeleccionadoSpan = document.getElementById("campoSeleccionado");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    const botonesCampo = document.querySelectorAll(".field-btn");
    botonesCampo.forEach(btn => {
      btn.onclick = () => {
        if (isRecording) return alert("Detén la grabación primero");
        botonesCampo.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        campoSeleccionado = btn.getAttribute("data-field");
        campoSeleccionadoSpan.textContent = btn.textContent;
        transcripcionP.textContent = "";
        textoCompleto = "";
        startBtn.disabled = false;
      }
    });

    startBtn.onclick = () => {
      if (!campoSeleccionado) return;
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "es-ES";
      recognition.interimResults = true;
      recognition.continuous = true;
      recognition.onresult = e => {
        let temp = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const result = e.results[i];
          const transcript = result[0].transcript;
          if (result.isFinal) {
            textoCompleto += transcript + " ";
          } else {
            temp += transcript;
          }
        }
        transcripcionP.textContent = textoCompleto + temp;
      };
      recognition.start();
      isRecording = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      recognition.stop();
      isRecording = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    // Función para convertir números en texto (0-99) a números
    function textoANumero(texto) {
      texto = texto.toLowerCase().trim();

      const unidades = {
        'cero':0, 'uno':1, 'dos':2, 'tres':3, 'cuatro':4, 'cinco':5,
        'seis':6, 'siete':7, 'ocho':8, 'nueve':9,
        'diez':10, 'once':11, 'doce':12, 'trece':13, 'catorce':14, 'quince':15,
        'dieciseis':16, 'dieciséis':16, 'diecisiete':17, 'dieciocho':18, 'diecinueve':19,
        'veinte':20, 'veintiuno':21, 'veintidos':22, 'veintidós':22, 'veintitres':23, 'veintitrés':23,
        'veinticuatro':24, 'veinticinco':25, 'veintiseis':26, 'veintiséis':26, 'veintisiete':27, 'veintiocho':28, 'veintinueve':29
      };

      const decenas = {
        'treinta':30, 'cuarenta':40, 'cincuenta':50, 'sesenta':60, 'setenta':70, 'ochenta':80, 'noventa':90
      };

      // Primero chequeamos si texto está en unidades
      if (unidades.hasOwnProperty(texto)) return unidades[texto];

      // Comprobar si es "treinta y cinco", "cuarenta y dos", etc.
      let partes = texto.split(' y ');
      if (partes.length === 2) {
        let dec = decenas[partes[0]];
        let uni = unidades[partes[1]];
        if (dec !== undefined && uni !== undefined) {
          return dec + uni;
        }
      }

      // Comprobar si es una decena sola
      if (decenas.hasOwnProperty(texto)) return decenas[texto];

      // Si no reconocemos, intentar parsear número directo (por si dice "25")
      let n = parseInt(texto);
      if (!isNaN(n)) return n;

      // Si nada, devolver el texto original
      return texto;
    }

    document.getElementById("checkTranscripcion").onclick = () => {
      if (campoSeleccionado) {
        let textoFinal = textoCompleto.trim();

        // Si es edad, convertir texto a número
        if (campoSeleccionado === 'edad') {
          let num = textoANumero(textoFinal);
          textoFinal = (typeof num === 'number') ? num.toString() : textoFinal;
        }

        camposGuardados[campoSeleccionado] = textoFinal;
        document.getElementById("tabla-" + campoSeleccionado).textContent = camposGuardados[campoSeleccionado];
        textoCompleto = "";
        transcripcionP.textContent = "";
      }
    };

    document.getElementById("wrongTranscripcion").onclick = () => {
      if (!campoSeleccionado) return;
      document.getElementById("modalBackdrop").style.display = "block";
      document.getElementById("editModal").style.display = "block";
      document.getElementById("editFieldLabel").textContent = campoSeleccionado;
      document.getElementById("editTextarea").value = textoCompleto.trim();
      document.getElementById("editContainer").style.display = "none";
    };

    document.getElementById("editField").onclick = () => {
      document.getElementById("editContainer").style.display = "block";
    };

    function cerrarModal() {
      document.getElementById("modalBackdrop").style.display = "none";
      document.getElementById("editModal").style.display = "none";
    }

    function guardarEdicion() {
      const nuevoTexto = document.getElementById("editTextarea").value.trim();
      camposGuardados[campoSeleccionado] = nuevoTexto;
      document.getElementById("tabla-" + campoSeleccionado).textContent = nuevoTexto;
      cerrarModal();
      textoCompleto = "";
      transcripcionP.textContent = "";
    }
  </script>
</body>
</html>


